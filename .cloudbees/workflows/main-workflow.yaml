apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: Main workflow
on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      bypass_security_gate:
        description: 'Bypass 30-minute security gate'
        type: boolean
        default: false
permissions:
  scm-token-own: read
  scm-token-org: read
  id-token: write
jobs:
  test:
    steps:
      - name: Run Jenkins Job
        kind: test
        uses: cloudbees-io/jenkins-run-job@v2
        continue-on-error: true
        with:
          url: https://sda.preview.cb-demos.io/westest/
          username: ${{ secrets.WES_JENKINS_USERNAME }}
          token: ${{ secrets.WES_JENKINS_TOKEN }}
          job-name: WesTestJob
      - name: Run GHA Workflow
        uses: cloudbees-io/ghactions-run-workflow@v2
        continue-on-error: true
        with:
          token: ${{ secrets.WES_GH_TOKEN }}
          org-name: cloudbees-days
          repo-name: hackers-WesTest1016
          branch-name: main
          workflow-name: test-and-build-image2
          test-type: JUnit
          test-result-location: junit.xml
      - name: Get source code
        uses: cloudbees-io/checkout@v1
        continue-on-error: true
      - name: Run unit tests
        kind: test
        id: RunUnitTest
        uses: docker://node:lts
        run: |
          npm ci
          npm run test:unit
          npx jest --coverage >> $CLOUDBEES_OUTPUTS/CODE_COVERAGE
      - name: Publish test results
        uses: cloudbees-io/publish-test-results@v1
        with:
          test-type: JUnit
          folder-name: ${{ cloudbees.workspace }}/junit.xml
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Test code coverage
            ${{ steps.RunUnitTest.outputs.CODE_COVERAGE }}
          format: MARKDOWN
    outputs:
      CODE_COVERAGE: ${{ steps.RunUnitTest.outputs.CODE_COVERAGE }}
  build-container-image:
    needs: test
    steps:
      - uses: cloudbees-io/checkout@v1
        name: Get source code
        kind: build
        continue-on-error: true
      - uses: cloudbees-io/configure-oci-credentials@v1
        name: Configure container registry credentials
        continue-on-error: true
        id: dockerconfig
        with:
          registry: https://index.docker.io/v1/
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: cloudbees-io/kaniko@v1
        name: Build container image
        kind: build
        with:
          destination: ${{ secrets.DOCKERHUB_USER }}/hackers-organized:${{ cloudbees.scm.sha }}
          tar-path: container-image.tar
          build-args: BUILDKIT_CONTEXT_KEEP_GIT_DIR=1,BUILDKIT_INLINE_CACHE=1
      - uses: cloudbees-io/asset-chain-utils-preprod/upload-binary@v1
        name: Upload binary from container build
        id: upload-binary
        with:
          file-path: container-image.tar
          file-type: BINARY_CONTAINER
          debug: "true"
      - name: Register build artifact
        id: register-artifact
        uses: cloudbees-io/register-build-artifact@v2
        with:
          name: "ldonleycb/hackers-organized"
          version: "${{ cloudbees.scm.sha }}"
          url: "${{ secrets.DOCKERHUB_USER }}/hackers-organized:${{ cloudbees.scm.sha }}"
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Built and pushed image to docker hub

            [Docker Hub](https://hub.docker.com/repository/docker/ldonleycb/hackers-organized/tags)

            **Artifact ID:** ${{ steps.register-artifact.outputs.artifact-id }}
            **Image:** hackers-organized:${{ cloudbees.scm.sha }}
          format: MARKDOWN
    outputs:
      ARTIFACT_ID: ${{ steps.register-artifact.outputs.artifact-id }}
  scan:
    outputs:
      BLOCKER_COUNT: ${{ steps.FetchSonarQubeIssues.outputs.BLOCKER_COUNT }}
      CRITICAL_COUNT: ${{ steps.FetchSonarQubeIssues.outputs.CRITICAL_COUNT }}
      MAJOR_COUNT: ${{ steps.FetchSonarQubeIssues.outputs.MAJOR_COUNT }}
      MINOR_COUNT: ${{ steps.FetchSonarQubeIssues.outputs.MINOR_COUNT }}
    steps:
      - name: Checkout
        uses: cloudbees-io/checkout@v1
      - name: Get code coverage
        kind: test
        uses: docker://node:lts
        run: |
          npm ci
          npm run test:coverage
      - uses: cloudbees-io/sonarqube-bundled-sast-scan-code@v1
        name: Scan with SonarQube
        kind: scan
        continue-on-error: true
        with:
          language: LANGUAGE_JS
          cover-file-name: coverage/clover.xml
          sonar-exclusion: tests/*
      - uses: cloudbees-io/snyk-sast-scan-code@v1
        name: Synk SAST
        kind: scan
        continue-on-error: true
        with:
          orgname: ${{ secrets.SNYK_ORGNAME }}
          token: ${{ secrets.SNYK_TOKEN }}
          language: LANGUAGE_JS
      - name: Scan with Snyk SCA
        uses: cloudbees-io/snyk-sca-scan-dependency@v1
        continue-on-error: true
        with:
          orgname: ${{ secrets.SNYK_ORGNAME }}
          token: ${{ secrets.SNYK_TOKEN }}
          language: LANGUAGE_JS
      - name: Fetch SonarQube Issues
        id: FetchSonarQubeIssues
        uses: docker://alpine/git:latest
        run: |
          apk add --no-cache curl jq
          curl -u ${{ secrets.SONAR_USER }}:${{ secrets.SONAR_TOKEN }} \
          "https://sonarqube.cb-demos.io/api/issues/search?componentKeys=HackersOrganized&severities=BLOCKER,CRITICAL,MAJOR,MINOR" \
          -o sonar-issues.json
          BLOCKER_COUNT=$(jq '[.issues[] | select(.severity=="BLOCKER")] | length' sonar-issues.json)
          CRITICAL_COUNT=$(jq '[.issues[] | select(.severity=="CRITICAL")] | length' sonar-issues.json)
          MAJOR_COUNT=$(jq '[.issues[] | select(.severity=="MAJOR")] | length' sonar-issues.json)
          MINOR_COUNT=$(jq '[.issues[] | select(.severity=="MINOR")] | length' sonar-issues.json)

          echo "${BLOCKER_COUNT}" >> $CLOUDBEES_OUTPUTS/BLOCKER_COUNT
          echo "${CRITICAL_COUNT}" >> $CLOUDBEES_OUTPUTS/CRITICAL_COUNT
          echo "${MAJOR_COUNT}" >> $CLOUDBEES_OUTPUTS/MAJOR_COUNT
          echo "${MINOR_COUNT}" >> $CLOUDBEES_OUTPUTS/MINOR_COUNT
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## SonarQube Analysis Results

            | Severity             | Issue Count |
            |----------------------|-------------|
            | BLOCKER_COUNT        | ${{ steps.FetchSonarQubeIssues.outputs.BLOCKER_COUNT }} |
            | CRITICAL_COUNT       | ${{ steps.FetchSonarQubeIssues.outputs.CRITICAL_COUNT }} |
            | MAJOR_COUNT          | ${{ steps.FetchSonarQubeIssues.outputs.MAJOR_COUNT }} |
            | MINOR_COUNT          | ${{ steps.FetchSonarQubeIssues.outputs.MINOR_COUNT }} |
          format: MARKDOWN
  security-check:
    needs:
      - build-container-image
      - scan
    outputs:
      vuln_count: ${{ steps.fetch-vulns.outputs.vuln_count }}
      severity_level: ${{ steps.fetch-vulns.outputs.severity_level }}
      very_high_count: ${{ steps.fetch-vulns.outputs.very_high_count }}
      high_count: ${{ steps.fetch-vulns.outputs.high_count }}
      medium_count: ${{ steps.fetch-vulns.outputs.medium_count }}
      low_count: ${{ steps.fetch-vulns.outputs.low_count }}
      total_count: ${{ steps.fetch-vulns.outputs.total_count }}
      scan_datetime: ${{ steps.fetch-vulns.outputs.scan_datetime }}
      gate_triggered: ${{ steps.fetch-vulns.outputs.gate_triggered }}
    steps:
      - name: Fetch Security Vulnerabilities
        id: fetch-vulns
        uses: docker://alpine:latest
        run: |
          apk add --no-cache curl jq

          SCAN_DATETIME=$(date '+%Y-%m-%d %H:%M:%S %Z')

          # Check bypass
          if [ "${{ secrets.WES_1Time_Bypass }}" = "TRUE" ]; then
            echo "üö® ONE-TIME SECURITY GATE BYPASS GRANTED!"
          else
            echo "‚úÖ No bypass active - normal security gate enforcement"
          fi

          # Dynamic CloudBees context variables
          COMPONENT_ID="${{ cloudbees.component.id }}"
          ORG_ID="${{ cloudbees.org.id }}"
          ENDPOINT_ID="e8c14f62-66e8-4846-a077-3b9a887a7255"
          BRANCH_NAME="${{ cloudbees.scm.branch }}"

          echo "üîç Using component: $COMPONENT_ID"
          echo "üîç Using branch: $BRANCH_NAME"

          # Build CloudBees Unify REST API URL with branch name
          API_URL="https://api.cloudbees.io/v1/resources/${ORG_ID}/endpoints/${ENDPOINT_ID}/asset-store/components/${COMPONENT_ID}/branches/${BRANCH_NAME}/issues"
          echo "‚úÖ CloudBees Unify API URL: $API_URL"

          # Make vulnerability API call
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CLOUDBEES_API_TOKEN }}" \
          "${API_URL}?pagination.sort.order=1&pagination.sort.field_name=severity&pagination.page_length=100&pagination.page=1&triageStatus=UNREVIEWED")

          # Validate API response
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "‚ùå Vulnerability API Error: $(echo "$RESPONSE" | jq -r '.error')"
            exit 1
          fi

          # Extract vulnerability counts
          VERY_HIGH_COUNT=$(echo "$RESPONSE" | jq '.issues | map(select(.severity == "VERY_HIGH")) | length')
          HIGH_COUNT=$(echo "$RESPONSE" | jq '.issues | map(select(.severity == "HIGH")) | length')
          MEDIUM_COUNT=$(echo "$RESPONSE" | jq '.issues | map(select(.severity == "MEDIUM")) | length')
          LOW_COUNT=$(echo "$RESPONSE" | jq '.issues | map(select(.severity == "LOW")) | length')
          TOTAL_COUNT=$(echo "$RESPONSE" | jq '.issues | length')

          # ENHANCED DUAL-THRESHOLD LOGIC: VERY HIGH ‚â•4 OR HIGH ‚â•6
          GATE_TRIGGERED="false"
          if [ "$VERY_HIGH_COUNT" -ge 4 ] || [ "$HIGH_COUNT" -ge 6 ]; then
            GATE_TRIGGERED="true"
            echo "üö® DUAL-THRESHOLD SECURITY GATE TRIGGERED!"
            echo "   - VERY HIGH: $VERY_HIGH_COUNT (threshold: ‚â•4)"
            echo "   - HIGH: $HIGH_COUNT (threshold: ‚â•6)"
            echo "   - Gate Logic: VERY HIGH ‚â•4 OR HIGH ‚â•6"
          else
            echo "‚úÖ DUAL-THRESHOLD SECURITY GATE PASSED"
            echo "   - VERY HIGH: $VERY_HIGH_COUNT (<4)"
            echo "   - HIGH: $HIGH_COUNT (<6)"
            echo "   - Gate Logic: VERY HIGH <4 AND HIGH <6"
          fi

          # Output results
          echo "$HIGH_COUNT" > $CLOUDBEES_OUTPUTS/vuln_count
          echo "$VERY_HIGH_COUNT" > $CLOUDBEES_OUTPUTS/very_high_count
          echo "$HIGH_COUNT" > $CLOUDBEES_OUTPUTS/high_count
          echo "$MEDIUM_COUNT" > $CLOUDBEES_OUTPUTS/medium_count
          echo "$LOW_COUNT" > $CLOUDBEES_OUTPUTS/low_count
          echo "$TOTAL_COUNT" > $CLOUDBEES_OUTPUTS/total_count
          echo "$SCAN_DATETIME" > $CLOUDBEES_OUTPUTS/scan_datetime
          echo "HIGH" > $CLOUDBEES_OUTPUTS/severity_level
          echo "$GATE_TRIGGERED" > $CLOUDBEES_OUTPUTS/gate_triggered

          echo "üîç Enhanced Security Scan Results:"
          echo "- VERY HIGH Vulnerabilities: $VERY_HIGH_COUNT"
          echo "- HIGH Vulnerabilities: $HIGH_COUNT"
          echo "- MEDIUM Vulnerabilities: $MEDIUM_COUNT"
          echo "- LOW Vulnerabilities: $LOW_COUNT"
          echo "- TOTAL Vulnerabilities: $TOTAL_COUNT"

          if [ "${{ secrets.WES_1Time_Bypass }}" = "TRUE" ]; then
            echo "- Security Gate: BYPASSED (Admin override)"
          else
            echo "- Security Gate Required: $([ "$GATE_TRIGGERED" = "true" ] && echo 'YES (Dual-threshold breach)' || echo 'NO (Within thresholds)')"
          fi

          echo "üéØ Deploy Job Advancement Conditions:"
          echo "   - Bypass Active: $([ "${{ secrets.WES_1Time_Bypass }}" = "TRUE" ] && echo 'YES - Deploy allowed' || echo 'NO')"
          echo "   - Gate Triggered: $([ "$GATE_TRIGGERED" = "true" ] && echo 'YES - Must pass security-gate' || echo 'NO - Deploy allowed')"
          echo "   - Final Decision: $([ "${{ secrets.WES_1Time_Bypass }}" = "TRUE" ] && echo 'DEPLOY (bypass)' || ([ "$GATE_TRIGGERED" = "true" ] && echo 'SECURITY-GATE REQUIRED' || echo 'DEPLOY (passed)'))"

      - name: Generate Enhanced Security Evidence Report
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            # Enhanced Dual-Threshold Security Vulnerability Report

            **Component:** ${{ cloudbees.component.id }}
            **Security Check Date & Time:** ${{ steps.fetch-vulns.outputs.scan_datetime }}
            **Total Vulnerabilities:** ${{ steps.fetch-vulns.outputs.total_count }}
            **Data Source:** Real-time CloudBees Unify REST API

            ## Enhanced Dual-Threshold Security Logic
            **Gate Triggered:** ${{ steps.fetch-vulns.outputs.gate_triggered }}
            **Trigger Logic:** VERY HIGH ‚â•4 OR HIGH ‚â•6 activates 30-minute security gate
            **Success Criteria:** VERY HIGH <4 AND HIGH <6 to proceed to deployment

            ## Severity Breakdown with Thresholds
            | Severity | Count | Threshold | Status |
            |----------|-------|-----------|--------|
            | Very High | ${{ steps.fetch-vulns.outputs.very_high_count }} | ‚â•4 triggers gate | ${{ steps.fetch-vulns.outputs.very_high_count >= 4 && '‚ùå BREACH' || '‚úÖ SAFE' }} |
            | High | ${{ steps.fetch-vulns.outputs.high_count }} | ‚â•6 triggers gate | ${{ steps.fetch-vulns.outputs.high_count >= 6 && '‚ùå BREACH' || '‚úÖ SAFE' }} |
            | Medium | ${{ steps.fetch-vulns.outputs.medium_count }} | - | - |
            | Low | ${{ steps.fetch-vulns.outputs.low_count }} | - | - |
            | **TOTAL** | ${{ steps.fetch-vulns.outputs.total_count }} | - | - |

            ## Deploy Job Advancement Analysis
            - **Bypass Status:** ${{ secrets.WES_1Time_Bypass == 'TRUE' && 'ACTIVE - Deploy allowed immediately' || 'INACTIVE - Normal gate enforcement' }}
            - **Gate Status:** ${{ steps.fetch-vulns.outputs.gate_triggered == 'true' && 'TRIGGERED - Security gate required' || 'PASSED - Deploy allowed' }}
            - **Final Decision:** ${{ secrets.WES_1Time_Bypass == 'TRUE' && 'DEPLOY (bypass override)' || (steps.fetch-vulns.outputs.gate_triggered == 'true' && 'SECURITY-GATE POLLING REQUIRED' || 'DEPLOY (thresholds met)') }}

            ## Enhanced Risk Assessment
            - **Critical Risk**: ${{ steps.fetch-vulns.outputs.very_high_count }} Very High vulnerabilities (4+ triggers gate)
            - **High Risk**: ${{ steps.fetch-vulns.outputs.high_count }} High severity vulnerabilities (6+ triggers gate)
            - **Flexible Remediation**: Developers can fix either VERY HIGH or HIGH vulnerabilities to meet criteria
            - **Total Risk**: All ${{ steps.fetch-vulns.outputs.total_count }} vulnerabilities require attention
          format: MARKDOWN
  security-gate:
    needs: security-check
    if: ${{ needs.security-check.outputs.gate_triggered == 'true' && secrets.WES_1Time_Bypass != 'TRUE' }}
    outputs:
      gate_status: ${{ steps.security-polling.outputs.gate_status }}
      final_very_high_count: ${{ steps.security-polling.outputs.final_very_high_count }}
      final_high_count: ${{ steps.security-polling.outputs.final_high_count }}
      poll_results: ${{ steps.security-polling.outputs.poll_results }}
    steps:
      - name: Enhanced Dual-Threshold Security Gate Polling
        id: security-polling
        uses: docker://alpine:latest
        run: |
          apk add --no-cache curl jq

          echo "üö® ENHANCED DUAL-THRESHOLD SECURITY GATE ACTIVATED üö®"
          echo "Initial VERY HIGH Vulnerabilities: ${{ needs.security-check.outputs.very_high_count }}"
          echo "Initial HIGH Vulnerabilities: ${{ needs.security-check.outputs.high_count }}"
          echo "Success Criteria: VERY HIGH <4 AND HIGH <6 (both conditions must be met)"
          echo "Polling Duration: 30 minutes (7 polls every 5 minutes)"
          echo ""

          # Initialize variables
          POLL_RESULTS=""
          GATE_STATUS="FAILED"
          FINAL_VERY_HIGH_COUNT=${{ needs.security-check.outputs.very_high_count }}
          FINAL_HIGH_COUNT=${{ needs.security-check.outputs.high_count }}
          START_TIME=$(date +%s)
          END_TIME=$((START_TIME + 1800))  # 30 minutes = 1800 seconds
          POLL_COUNT=0

          # Dynamic CloudBees context variables (same as security-check)
          COMPONENT_ID="${{ cloudbees.component.id }}"
          ORG_ID="${{ cloudbees.org.id }}"
          ENDPOINT_ID="e8c14f62-66e8-4846-a077-3b9a887a7255"
          BRANCH_NAME="${{ cloudbees.scm.branch }}"

          # Build API URL with branch name
          API_URL="https://api.cloudbees.io/v1/resources/${ORG_ID}/endpoints/${ENDPOINT_ID}/asset-store/components/${COMPONENT_ID}/branches/${BRANCH_NAME}/issues"

          echo "üéØ Deploy Job Advancement Tracking:"
          echo "   - Current Status: BLOCKED (security-gate running)"
          echo "   - Required for Deploy: VERY HIGH <4 AND HIGH <6"
          echo "   - Alternative: WES_1Time_Exception = TRUE"
          echo ""

          # Polling loop - exactly 30 minutes with 5-minute intervals
          while [ $(date +%s) -lt $END_TIME ]; do
            POLL_COUNT=$((POLL_COUNT + 1))
            POLL_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
            ELAPSED_MIN=$(( (POLL_COUNT - 1) * 5 ))

            echo "üîç Enhanced Dual-Threshold Security Poll #${POLL_COUNT}/7 (${ELAPSED_MIN}:00 elapsed)"

            # Make API call to check current vulnerability counts
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.CLOUDBEES_API_TOKEN }}" \
            "${API_URL}?pagination.sort.order=1&pagination.sort.field_name=severity&pagination.page_length=100&pagination.page=1&triageStatus=UNREVIEWED")

            # Extract current counts
            if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
              echo "‚ùå API Error during poll #${POLL_COUNT}: $(echo "$RESPONSE" | jq -r '.error')"
              CURRENT_VERY_HIGH_COUNT=${{ needs.security-check.outputs.very_high_count }}
              CURRENT_HIGH_COUNT=${{ needs.security-check.outputs.high_count }}
            else
              CURRENT_VERY_HIGH_COUNT=$(echo "$RESPONSE" | jq '.issues | map(select(.severity == "VERY_HIGH")) | length')
              CURRENT_HIGH_COUNT=$(echo "$RESPONSE" | jq '.issues | map(select(.severity == "HIGH")) | length')
            fi

            echo "   üìä Current Counts: ${CURRENT_VERY_HIGH_COUNT} VERY HIGH, ${CURRENT_HIGH_COUNT} HIGH"
            FINAL_VERY_HIGH_COUNT=$CURRENT_VERY_HIGH_COUNT
            FINAL_HIGH_COUNT=$CURRENT_HIGH_COUNT

            # Build poll results for evidence
            POLL_RESULTS="${POLL_RESULTS}- **Poll #${POLL_COUNT}** (${POLL_TIME}): ${CURRENT_VERY_HIGH_COUNT} VERY HIGH, ${CURRENT_HIGH_COUNT} HIGH vulnerabilities"

            # ENHANCED SUCCESS CRITERIA: VERY HIGH <4 AND HIGH <6
            if [ $CURRENT_VERY_HIGH_COUNT -lt 4 ] && [ $CURRENT_HIGH_COUNT -lt 6 ]; then
              echo "   ‚úÖ SUCCESS: Enhanced dual-threshold criteria met!"
              echo "      - VERY HIGH: ${CURRENT_VERY_HIGH_COUNT} (<4) ‚úÖ"
              echo "      - HIGH: ${CURRENT_HIGH_COUNT} (<6) ‚úÖ"
              echo "   üéØ Deploy Job Status: UNBLOCKED - Deploy job can proceed"
              POLL_RESULTS="${POLL_RESULTS} ‚úÖ **PASSED**"$'\n'
              GATE_STATUS="PASSED"
              break
            else
              echo "   ‚ö†Ô∏è  Enhanced dual-threshold criteria not met:"
              echo "      - VERY HIGH: ${CURRENT_VERY_HIGH_COUNT} $([ $CURRENT_VERY_HIGH_COUNT -ge 4 ] && echo '(‚â•4) ‚ùå' || echo '(<4) ‚úÖ')"
              echo "      - HIGH: ${CURRENT_HIGH_COUNT} $([ $CURRENT_HIGH_COUNT -ge 6 ] && echo '(‚â•6) ‚ùå' || echo '(<6) ‚úÖ')"
              echo "   üéØ Deploy Job Status: BLOCKED - Both conditions must be met"
              POLL_RESULTS="${POLL_RESULTS}"$'\n'
            fi

            # Break if we've done 7 polls
            if [ $POLL_COUNT -ge 7 ]; then break; fi

            # Wait 5 minutes before next poll
            echo "   ‚è∞ Waiting 5 minutes before next poll..."
            sleep 300
          done

          # Check for One-Time Vulnerability Exception after polling completes
          if [ "$GATE_STATUS" = "FAILED" ]; then
            echo ""
            echo "üîç Checking One-Time Vulnerability Exception..."
            if [ "${{ secrets.WES_1Time_Exception }}" = "TRUE" ]; then
              echo "üö® ONE-TIME VULNERABILITY EXCEPTION GRANTED!"
              echo "Security gate bypassed by administrative override"
              echo "üéØ Deploy Job Status: UNBLOCKED - Exception override active"
              GATE_STATUS="PASSED"
              POLL_RESULTS="${POLL_RESULTS}- **EXCEPTION GRANTED**: One-time vulnerability exception applied"$'\n'
            else
              echo "‚ùå No exception granted - Security gate enforcement active"
              echo "üéØ Deploy Job Status: BLOCKED - Criteria not met, no exception"
            fi
          fi

          # Final status
          if [ "$GATE_STATUS" = "PASSED" ]; then
            echo ""
            echo "üéâ ENHANCED DUAL-THRESHOLD SECURITY GATE PASSED!"
            echo "Final VERY HIGH vulnerability count: ${FINAL_VERY_HIGH_COUNT}"
            echo "Final HIGH vulnerability count: ${FINAL_HIGH_COUNT}"
            echo "üéØ Deploy Job Advancement: APPROVED - All conditions met"
          else
            echo ""
            echo "‚ùå ENHANCED DUAL-THRESHOLD SECURITY GATE FAILED!"
            echo "Final VERY HIGH vulnerability count: ${FINAL_VERY_HIGH_COUNT}"
            echo "Final HIGH vulnerability count: ${FINAL_HIGH_COUNT}"
            echo "üéØ Deploy Job Advancement: BLOCKED - Enhanced security criteria not met"
            echo "Developer must fix vulnerabilities to meet: VERY HIGH <4 AND HIGH <6"
          fi

          # Output results
          echo "$GATE_STATUS" > $CLOUDBEES_OUTPUTS/gate_status
          echo "$FINAL_VERY_HIGH_COUNT" > $CLOUDBEES_OUTPUTS/final_very_high_count
          echo "$FINAL_HIGH_COUNT" > $CLOUDBEES_OUTPUTS/final_high_count
          echo "$POLL_RESULTS" > $CLOUDBEES_OUTPUTS/poll_results

          # Exit with error if gate failed
          if [ "$GATE_STATUS" = "FAILED" ]; then
            exit 1
          fi

      - name: Publish Enhanced Security Gate Evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            # Enhanced Dual-Threshold Security Gate Results

            **Gate Status:** ${{ steps.security-polling.outputs.gate_status }}
            **Initial VERY HIGH Count:** ${{ needs.security-check.outputs.very_high_count }}
            **Initial HIGH Count:** ${{ needs.security-check.outputs.high_count }}
            **Final VERY HIGH Count:** ${{ steps.security-polling.outputs.final_very_high_count }}
            **Final HIGH Count:** ${{ steps.security-polling.outputs.final_high_count }}
            **Polling Duration:** 30 minutes (7 polls every 5 minutes)

            ## Enhanced Dual-Threshold Security Logic
            **Success Criteria:** VERY HIGH <4 AND HIGH <6 (both conditions must be met)
            **Gate Trigger:** VERY HIGH ‚â•4 OR HIGH ‚â•6 (either condition triggers gate)
            **Flexible Remediation:** Developers can focus on either vulnerability type for fastest resolution

            ## Deploy Job Advancement Analysis
            - **Gate Result:** ${{ steps.security-polling.outputs.gate_status }}
            - **Deploy Status:** ${{ steps.security-polling.outputs.gate_status == 'PASSED' && 'APPROVED - Deploy job can proceed' || 'BLOCKED - Enhanced security criteria not met' }}
            - **Required Action:** ${{ steps.security-polling.outputs.gate_status == 'PASSED' && 'None - All conditions satisfied' || 'Fix vulnerabilities to meet VERY HIGH <4 AND HIGH <6' }}

            ## Polling Timeline
            ${{ steps.security-polling.outputs.poll_results }}

            ## Enhanced Security Gate Benefits
            - **Dual Protection:** Guards against both critical (VERY HIGH) and significant (HIGH) vulnerabilities
            - **Developer Flexibility:** Multiple remediation paths to meet security criteria
            - **Real-time Monitoring:** Continuous assessment during 30-minute window
            - **Administrative Controls:** Bypass and exception capabilities for urgent deployments

            **Result:** ${{ steps.security-polling.outputs.gate_status == 'PASSED' && 'Enhanced security standards met - deployment approved' || 'Enhanced security standards not met - deployment blocked' }}
          format: MARKDOWN
  deploy:
    environment: DOW Production
    steps:
      - name: Checkout
        uses: cloudbees-io/checkout@v1
      - uses: cloudbees-days/setup-kubeconfig
        name: Set kubeconfig
        with:
          kubeconfig: ${{ secrets.kubeconfig }}
      - name: Deploy to cluster
        uses: cloudbees-io/kustomize-deploy@v1
        kind: deploy
        with:
          kustomization-base-dir: ${{ cloudbees.workspace }}/k8s/base
          kustomization-overlays-dir: ${{ cloudbees.workspace }}/k8s/overlays/prod
          environment-variables: "{}"
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Deployed environment
            [Production frontend](https://hackers-organized-prod.preview.cb-demos.io/)

            Running hackers-organized:${{ cloudbees.scm.sha }}
            **Artifact ID:** ${{ needs.build-container-image.outputs.ARTIFACT_ID }}
          format: MARKDOWN
      - name: Register deployed artifact
        uses: cloudbees-io/register-deployed-artifact@v2
        with:
          artifact-id: ${{ needs.build-container-image.outputs.ARTIFACT_ID }}
          target-environment: "DOW Production"
    needs:
      - build-container-image
      - scan
      - security-check
      - security-gate